<?phpinclude('functions.php');if(isset($_POST["Import_csv"])){	// output headers so that the file is downloaded rather than displayed	header('Content-type: text/csv');	header('Content-Disposition: attachment; filename="demo.csv"');	 	// do not cache the file	header('Pragma: no-cache');	header('Expires: 0');	$filename=$_FILES["file"]["tmp_name"]; 	$row = 1;	$skus = array();	$backers = array();	$file_data = array();		if($_FILES["file"]["size"] > 0) {		if (($handle = fopen($filename, "r")) !== FALSE) {			while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {				if($row>1){					$num = count($data);					$file_data[]=$data;										if(!isset($backers[$data[0]])) 						$backers[$data[0]] = ['email'=>$data[2], 'phone'=>$data[3], 'name'=>stripAccents($data[5]), 'address'=>stripAccents($data[6]), 'address2'=>stripAccents($data[7]), 'city'=>stripAccents($data[8]), 'province'=>stripAccents($data[9]), 'postalcode'=>preg_replace("/[^a-zA-Z0-9]/", "", $data[10]), 'country'=>$data[11], 'notes'=>$data[12] ];					$backers[$data[0]]['sku'][$data[20]] = $data[23];										if(!isset($skus[$data[20]])) 						$skus[$data[20]] = ['title'=>$data[21], 'cost'=>$data[22], 'weight'=>$data[24], 'length'=>$data[25], 'width'=>$data[26], 'height'=>$data[27]];				}				$row++;			}						fclose($handle);		}	}	//header -> description des skus	$header[0]=explode(",", "external_id,customer_email,customer_phone,shipping_name,shipping_address,shipping_address2,shipping_city,shipping_province,shipping_postal_code,shipping_country,shipping_method,customer_notes,gift_notes");		$blancs=explode(",", ",,,,,,,,,,,");	for($i=1;$i<=6;$i++) { $header[$i]=$blancs; }	$header[1][] = "SKU:";	$header[2][] = "Weight (kg):";	$header[3][] = "Length (cm):";	$header[4][] = "Width (cm):";	$header[5][] = "Height (cm):";	$header[6][] = "Cost:";		foreach($skus as $id=>$sku){		$header[0][] = $sku['title'];		$header[1][] = $id;		$header[2][] = $sku['weight'];		$header[3][] = $sku['length'];		$header[4][] = $sku['width'];		$header[5][] = $sku['height'];		$header[6][] = $sku['cost'];	}	$header[0] = array_merge($header[0], explode(",", "weight,amount_total"));	for($i=1;$i<=6;$i++) { $header[$i] = array_merge($header[$i], [" "," "]); }		$header[7]=explode(",", ",,,,,,,,,,,,,,,,,");	//body	$body = array();	foreach($backers as $id=>$backer){		$bodyline = [$id, $backer['email'], $backer['phone'], $backer['name'], $backer['address'], $backer['address2'], $backer['city'], $backer['province'], $backer['postalcode'], $backer['country'], 'Standard Shipping', $backer['notes'], ''];				$tmp_co = $tmp_we = 0;		foreach($skus as $id_sku=>$sku){			$qty=0;			if (isset($backer['sku'][$id_sku])) $qty = $backer['sku'][$id_sku];			$tmp_co += $sku['cost']*$qty;			$tmp_we += $sku['weight']*$qty;			$bodyline[]=$qty;		}				$bodyline[]=$tmp_we;		$bodyline[]=$tmp_co; 		$body[]=$bodyline;	}		// create a file pointer connected to the output stream	$file = fopen('php://output', 'w');	foreach($header as $line){		fputcsv($file, $line);	}	foreach($body as $line){		fputcsv($file, $line);	}		exit();}else{//viewrequire 'view/convert.tpl.php';}