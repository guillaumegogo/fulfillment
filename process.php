<?phpsession_start();$answers = array();if(isset($_POST["Import_csv"])){	$_SESSION["file_data"]=null;	$_SESSION["answers"]=null;	include("src/Packer.php");		$filename=$_FILES["file"]["tmp_name"]; 	$optimize=0;	if(isset($_POST["optimize"]) && $_POST["optimize"] > 0) $optimize=1;	$prefered=0;	if(isset($_POST["prefered"]) && $_POST["prefered"] > 0) $prefered=1;	$row = 1;	$skus = array();	$configs = array();	$prefered_cartons = [[8,6,3],[8,6,4],[8,6,5],[12,12,4],[13,10,4],[16,12,4],[16,12,6],[16,12,7]];	if($_FILES["file"]["size"] > 0) {		if (($handle = fopen($filename, "r")) !== FALSE) {			while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {				$num = count($data);				$_SESSION["file_data"][]=$data;								$labels=["name","id","kg","l","w","h"];				if($row==1 || $row==2 || $row==3 ){					for($i=13; $i < $num-2; $i++){						$skus[$i-13][$labels[$row-1]] = $data[$i];					}				}				if($row==4 || $row==5 || $row==6 ){					for($i=13; $i < $num-2; $i++){						$skus[$i-13][$labels[$row-1]] = round($data[$i]/2.54,1, PHP_ROUND_HALF_UP);					}				}								if($row>8){					$items=(array)null;					for($i=13; $i < $num-2; $i++){						$items[] = $data[$i];					}					$label=implode($items,'-');										$description="";					foreach($items as $k=>$nb){						if($nb>0) $description .= $nb.'*'.$skus[$k]["id"].'+';					}					$description = substr_replace($description ,"", -1);					$configs[$label]['description']=$description;										if(!isset($configs[$label]['items'])){ 						$configs[$label]['items']=$items;					}					$configs[$label]['nb']++;				}								$row++;			}			fclose($handle);		}	}		$lp = new Cloudstek\PhpLaff\Packer();		foreach($configs as &$config){				$boxes=null;		foreach($config as $key => $detail){			if($key=='items'){				foreach($detail as $i => $nb){					for($j=1; $j<=$nb; $j++){						//$tmp_dim = [ceil($skus[$i]['l'] * 10)/10, ceil($skus[$i]['w'] * 10)/10, ceil($skus[$i]['h'] * 10)/10];						$tmp_dim = [$skus[$i]['l'], $skus[$i]['w'], $skus[$i]['h']];						rsort($tmp_dim);						$boxes[] = ['length' => $tmp_dim[0], 'width' => $tmp_dim[1], 'height' => $tmp_dim[2]];					}				}			}		}		$config['boxes']=$boxes;				$lp->pack($config['boxes']);		$c_size = $lp->get_container_dimensions();		$config['ctnr']['brut'] = $c_size; 		$config['ctnr']['ok'] = $c_size; 		rsort($config['ctnr']['ok']);				$config['ctnr']['ok'][0] = ceil($config['ctnr']['ok'][0]+0.1);		$config['ctnr']['ok'][1] = ceil($config['ctnr']['ok'][1]+0.1);		$config['ctnr']['ok'][2] = ceil($config['ctnr']['ok'][2]+0.1);				//verif meilleure config		if($optimize){			$ref0=$config['ctnr']['ok'][0]; 			$ref1=$config['ctnr']['ok'][1]; 			$ref2=$config['ctnr']['ok'][2]; 			$average=ceil(pow($ref0*$ref1*$ref2, 1/3));						for($i=$average; $i<=$average*2; $i++){				for($j=1; $j<=$i; $j++){					$other_lp = new Cloudstek\PhpLaff\Packer();					$other_lp->pack($boxes, ['length' => $i, 'width' => $j,'height' => 0]);					$other_lp_size = $other_lp->get_container_dimensions();					rsort($other_lp_size);										$test0=ceil($other_lp_size[0]+0.1);					$test1=ceil($other_lp_size[1]+0.1);					$test2=ceil($other_lp_size[2]+0.1);										//si alternative + interessante on garde					if($test0*$test1*$test2 < $ref0*$ref1*$ref2){						$ref0=$test0; 						$ref1=$test1; 						$ref2=$test2; 					}				}			}						$config['ctnr']['ok'][0] = $ref0;			$config['ctnr']['ok'][1] = $ref1;			$config['ctnr']['ok'][2] = $ref2;		}				if($prefered){			foreach($prefered_cartons as $prefered){				if($config['ctnr']['ok'][0]<=$prefered[0] && 					$config['ctnr']['ok'][1]<=$prefered[1] && 					$config['ctnr']['ok'][2]<=$prefered[2] && 					$other_lp_size[0]*$other_lp_size[1]*$other_lp_size[2]>=0.7*$prefered[0]*$prefered[1]*$prefered[2]){					$config['ctnr']['ok'][0]=$prefered[0];					$config['ctnr']['ok'][1]=$prefered[1];					$config['ctnr']['ok'][2]=$prefered[2]; 				}			}		}	}		foreach($configs as $key => &$config){					if (($config['ctnr']['ok'][0]+$config['ctnr']['ok'][1]+$config['ctnr']['ok'][2])*2-max($config['ctnr']['ok'][0],$config['ctnr']['ok'][1],$config['ctnr']['ok'][2])>118){			$case="multipieces";		}else{			$case = $config['ctnr']['ok'][0].'x'.$config['ctnr']['ok'][1].'x'.$config['ctnr']['ok'][2];		}		if(!isset($answers[$case])){			$answers[$case]['label'] = $case;			$answers[$case]['l'] = $config['ctnr']['ok'][0];			$answers[$case]['w'] = $config['ctnr']['ok'][1];			$answers[$case]['h'] = $config['ctnr']['ok'][2];		}		$answers[$case]['nb'] += $config['nb'];		//$answers[$case]['configs'][] = $key;		//$answers[$case]['boxes']=$config['boxes'];		$answers[$case]['configs'][$key]['boxes']=$config['boxes'];		$answers[$case]['configs'][$key]['description']=$config['description'];	}		function cmp($a, $b){		if($a['label']=='multipieces') return -1;		elseif($b['label']=='multipieces') return 1;		elseif($a['l']>=$b['l'] && $a['w']>=$b['w'] && $a['h']>=$b['h']) return -1;		elseif($a['l']<=$b['l'] && $a['w']<=$b['w'] && $a['h']<=$b['h']) return 1;		else return $b['l']*$b['w']*$b['h']-$a['l']*$a['w']*$a['h'];		//return ($b['l']*10000+$b['w']*100+$b['h'])-($a['l']*10000+$a['w']*100+$a['h']);	}	usort($answers, "cmp");	$_SESSION["answers"]=$answers;}if(isset($_POST["Submit_boxes"])){		$answers=$_SESSION["answers"];	$token=null;	$file_list=null;	$i=1;		foreach($_POST["last"] as $key=>$details){				if($i++==1 || $details["box"]) {			$file_list[$key]["nb"] = $details["nb"];			$file_list[$key]["configs"] = $details["configs"];			$token = $key;		}else{			$file_list[$token]["nb"] += $details["nb"];			$file_list[$token]["configs"] = array_merge($file_list[$token]["configs"], $details["configs"]);		}	}}//viewrequire 'view/process.tpl.php';